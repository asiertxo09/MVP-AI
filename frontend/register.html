<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Crear cuenta · EduPlay</title>
    <style>
        :root{color-scheme:dark}
        body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0f172a;color:#e2e8f0}
        .wrap{max-width:460px;margin:8vh auto;padding:24px}
        form{display:grid;gap:12px;background:#111827;border:1px solid #1f2937;border-radius:16px;padding:24px}
        input,button{font-size:16px}
        input{padding:12px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
        button{padding:12px;border-radius:10px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:600}
        button[disabled]{opacity:.6;cursor:wait}
        .checkbox{display:flex;align-items:flex-start;gap:10px;font-size:.95rem;color:#cbd5f5}
        .checkbox input{margin-top:4px;width:18px;height:18px}
        a{color:#60a5fa}
        .err{color:#fca5a5}
        .status{color:#a5b4fc;font-size:.95rem}
        .foot{text-align:center;margin-top:16px;color:#cbd5f5}
        .wrap h1{margin:0 0 18px;font-size:1.8rem;color:#fff}
        label{font-weight:600;color:#cbd5f5}
        .field{display:grid;gap:6px}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Crea tu cuenta</h1>
    <form id="register" novalidate>
        <div class="field">
            <label for="name">Nombre completo</label>
            <input id="name" name="name" placeholder="Ej. Laura Gómez" autocomplete="name" required />
        </div>
        <div class="field">
            <label for="username">Correo electrónico o usuario</label>
            <input id="username" name="username" type="text" inputmode="email" placeholder="tu@correo.com o usuario" autocomplete="username" pattern="[A-Za-z0-9._@+-]{3,120}" title="Usa entre 3 y 120 caracteres. Se permiten letras, números, puntos, guiones, guion bajo y @" required />
        </div>
        <div class="field">
            <label for="password">Contraseña</label>
            <input id="password" name="password" type="password" autocomplete="new-password" minlength="8" required />
        </div>
        <div class="field">
            <label for="confirm">Confirmar contraseña</label>
            <input id="confirm" name="confirm" type="password" autocomplete="new-password" minlength="8" required />
        </div>
        <label class="checkbox">
            <input type="checkbox" id="consent" name="consent" required />
            <span>Acepto los términos del servicio y la política de privacidad.</span>
        </label>
        <button type="submit" id="submit">Crear cuenta</button>
        <p class="status" id="status" role="status" aria-live="polite"></p>
        <p class="err" id="error" role="alert" aria-live="assertive"></p>
    </form>
    <p class="foot">¿Ya tienes cuenta? <a href="/login">Inicia sesión</a></p>
</div>
<script>
    const form = document.getElementById('register');
    const status = document.getElementById('status');
    const error = document.getElementById('error');
    const submit = document.getElementById('submit');

    const usernamePattern = /^[A-Za-z0-9._@+-]{3,120}$/;

    form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        error.textContent = '';
        status.textContent = '';

        const fd = new FormData(form);
        const payload = {
            name: fd.get('name')?.trim(),
            username: fd.get('username')?.trim(),
            password: fd.get('password'),
            confirm: fd.get('confirm'),
            consent: form.consent.checked
        };

        if (!payload.name) {
            error.textContent = 'Indica tu nombre para personalizar la experiencia.';
            form.name.focus();
            return;
        }
        if (payload.name.length > 120) {
            error.textContent = 'El nombre es demasiado largo.';
            form.name.focus();
            return;
        }
        if (!payload.username || !usernamePattern.test(payload.username)) {
            error.textContent = 'Introduce un correo o usuario válido (mínimo 3 caracteres).';
            form.username.focus();
            return;
        }
        if (!payload.password || payload.password.length < 8) {
            error.textContent = 'La contraseña debe tener al menos 8 caracteres.';
            form.password.focus();
            return;
        }
        if (payload.password !== payload.confirm) {
            error.textContent = 'Las contraseñas no coinciden.';
            form.confirm.focus();
            return;
        }
        if (!payload.consent) {
            error.textContent = 'Debes aceptar los términos del servicio para continuar.';
            form.consent.focus();
            return;
        }

        submit.disabled = true;
        status.textContent = 'Creando tu cuenta…';

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                status.textContent = 'Cuenta creada con éxito. Redirigiendo…';
                setTimeout(() => {
                    window.location.href = '/login?registered=1';
                }, 700);
            } else {
                const msg = (await res.text()) || 'No se pudo crear la cuenta.';
                error.textContent = msg;
                submit.disabled = false;
                status.textContent = '';
            }
        } catch (err) {
            console.error(err);
            error.textContent = 'Ha ocurrido un error inesperado. Intenta nuevamente.';
            submit.disabled = false;
            status.textContent = '';
        }
    });
</script>
</body>
</html>
