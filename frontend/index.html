<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI EduPlay — Adaptativo con IA (Groq)</title>
    <style>
        :root {
            --bg: #fefcf6;
            --card: #ffffff;
            --soft: #faf7ef;
            --ink: #222;
            --ok: #2b8a3e;
            --bad: #e03131;
            --blue: #1c7ed6;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg);
            color: var(--ink);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", sans-serif
        }

        .app {
            width: min(1000px, 96vw);
            height: min(92vh, 900px);
            background: var(--card);
            border-radius: 28px;
            box-shadow: 0 10px 28px rgba(0, 0, 0, .08);
            overflow: hidden;
            display: grid;
            grid-template-rows: auto 1fr auto;
            border: 8px solid #f0e9d9
        }

        header {
            padding: 18px 22px;
            background: linear-gradient(90deg, #7ec8ff, #bfe4ff);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        h1 {
            margin: 0;
            font-size: clamp(20px, 3.4vw, 28px);
            color: #04324f;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .screen {
            padding: 24px;
            overflow: auto;
            display: grid;
            gap: 24px
        }

        .grid3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px
        }

        @media (max-width:820px) {
            .grid3 {
                grid-template-columns: 1fr
            }
        }

        .big-btn {
            border: 0;
            border-radius: 22px;
            padding: 26px;
            font-size: clamp(18px, 3.4vw, 22px);
            font-weight: 800;
            color: #082a41;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 0 rgba(0, 0, 0, .06);
            min-height: 120px
        }

        .btn-math {
            background: #c8f7c5
        }

        .btn-write {
            background: #ffe2b3
        }

        .btn-speak {
            background: #cce5ff
        }

        .btn-draw {
            background: #ffd6e0
        }

        .btn-transcribe {
            background: #e6d0ff
        }

        .card {
            background: var(--soft);
            border: 2px solid #f0eadc;
            border-radius: 20px;
            padding: 20px
        }

        .title {
            font-size: clamp(18px, 3.4vw, 22px);
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center
        }

        .prompt {
            font-size: clamp(20px, 4vw, 26px);
            text-align: center
        }

        .section {
            display: grid;
            gap: 18px
        }

        .input {
            font-size: 24px;
            padding: 14px 16px;
            border: 3px solid #dcd3be;
            border-radius: 16px;
            width: 100%;
        }

        .small {
            font-size: 18px;
            padding: 14px 18px;
            border-radius: 16px;
            border: 0;
            background: var(--blue);
            color: #fff;
            cursor: pointer
        }

        .choices {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px
        }

        .choice {
            font-size: 24px;
            padding: 18px;
            border-radius: 16px;
            border: 2px solid #e7ddc8;
            background: #fff;
            cursor: pointer
        }

        .feedback {
            font-weight: 900;
            font-size: clamp(20px, 3.6vw, 26px);
            margin-top: 8px
        }

        .ok {
            color: var(--ok)
        }

        .bad {
            color: var(--bad)
        }

        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            background: #f7f3ea;
            border-top: 2px solid #efe6d3
        }

        .levels {
            font-size: 15px;
            background: #fff;
            border: 2px solid #efe6d3;
            border-radius: 999px;
            padding: 8px 12px
        }

        .pill {
            background: #eef7ff;
            border: 2px solid #d7eaff;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 14px
        }

        .md p {
            margin: 0 0 8px
        }

        .md ul {
            margin: 8px 0 8px 18px
        }

        .md li {
            margin: 6px 0
        }

        .input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .speech-input {
            background: #f9f9f9;
            border: 2px solid #dcd3be;
            border-radius: 16px;
            padding: 16px 16px 50px 16px;
            position: relative;
            min-height: 80px;
        }

        .speech-display {
            font-size: 20px;
            color: #333;
            min-height: 40px;
            line-height: 1.3;
        }

        .speech-hint {
            position: absolute;
            bottom: 12px;
            left: 16px;
            right: 16px;
            font-size: 14px;
        }

        .speech-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .btn-stop {
            background: #e03131;
            color: white;
            border: 0;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
        }

        .btn-stop:enabled {
            opacity: 1;
        }

        .btn-stop:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
    <!-- Markdown renderer (subset). Si prefieres parser propio, quita este script y usa un renderizador seguro a medida. -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
<main class="app" role="main" aria-label="AI EduPlay">
    <header>
        <h1>🧸 AI EduPlay</h1>
        <div class="pill" id="status">Modo adaptativo con IA</div>
    </header>

    <section class="screen" id="screen"></section>

    <footer>
        <div class="levels" id="levels">Adaptándose...</div>
        <button class="small" id="btnHome">Inicio</button>
    </footer>
</main>

<script>
    // ===== Config IA (backend separado) =====
    const USE_AI = true;
    const API_URL = 'https://eduplay-backend.onrender.com/api/generate';
    const IMAGE_URL = 'https://eduplay-backend.onrender.com/image';

    async function generateWithAI(prompt) {
        if (!USE_AI) return null;
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            if (!res.ok) throw new Error('IA no disponible');
            const data = await res.json();
            return (data.text || '').trim();
        } catch (e) {
            console.warn('IA error', e);
            return null;
        }
    }

    async function generateImage(prompt, style) {
        // Try Flask image service first (port 5001), then fallback to Node service (port 3001)
        const payload = { prompt, style };
        // Primary: Flask
        try {
            const res = await fetch(IMAGE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('flask fail');
            return await res.blob();
        } catch (e) {
            console.warn('Flask image error, trying Node fallback', e);
        }
        // Fallback: Node backend at /api/image (combines style server-side if supported)
        try {
            const res = await fetch('http://localhost:3001/api/image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'image/png' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('node fail');
            return await res.blob();
        } catch (e2) {
            console.warn('Node image error', e2);
            return null;
        }
    }

    // Markdown seguro (ya integrado). Si se requiere sanitizar, integrar DOMPurify.
    marked.setOptions({ mangle: false, headerIds: false, breaks: true });
    function renderMarkdown(text) {
        if (!text) return '';
        return `<div class="md">${marked.parse(text)}</div>`;
    }
    async function aiTip(prompt) {
        const t = await generateWithAI(prompt);
        return t ? renderMarkdown(t) : '';
    }

    // ===== Estado simplificado - solo memoria de interacciones =====
    const state = {
        // Memoria de últimas 10 interacciones para cada sección
        interactions: {
            math: [],
            write: [],
            speak: []
        }
    };

    const INTERACTION_LIMIT = 10; // Guardamos las últimas 10 interacciones

    const screen = document.getElementById('screen');
    const btnHome = document.getElementById('btnHome');
    const levelsBox = document.getElementById('levels');
    btnHome.addEventListener('click', renderHome);

    function updateStatusUI() {
        const totalInteractions = Object.values(state.interactions).reduce((sum, arr) => sum + arr.length, 0);
        levelsBox.textContent = `${totalInteractions} interacciones registradas`;
    }

    function saveInteraction(section, challenge, userResponse, isCorrect) {
        const interaction = {
            challenge,
            userResponse,
            isCorrect,
            timestamp: Date.now()
        };

        state.interactions[section].push(interaction);
        if (state.interactions[section].length > INTERACTION_LIMIT) {
            state.interactions[section].shift(); // Mantener solo las últimas 10
        }
        updateStatusUI();
    }

    // ===== Generación dinámica de contenido con IA =====
    async function generateMathProblem() {
        const interactions = state.interactions.math;
        const interactionContext = interactions.length > 0
            ? `Historial de últimas interacciones matemáticas: ${JSON.stringify(interactions)}`
            : "Sin historial previo en matemáticas.";

        const prompt = `Eres un tutor de matemáticas adaptativo para niños de 5-12 años.

${interactionContext}

Basándote en el historial de respuestas (si existe), ajusta automáticamente la dificultad:
- Si el niño acierta consistentemente, incrementa la dificultad
- Si falla mucho, simplifica los problemas
- Si no hay historial, empieza con nivel básico

Genera un problema matemático apropiado. Responde SOLO en formato JSON:
{
  "question": "problema matemático",
  "answer": número_respuesta_correcta,
  "distractors": [num1, num2, num3, num4, num5]
}

Progresión sugerida de dificultad:
- Principiante: sumas simples 1-10
- Intermedio: sumas/restas hasta 20, introducir multiplicación simple
- Avanzado: operaciones con paréntesis, multiplicación/división, números más grandes

Evita repetir problemas similares del historial.`;

        try {
            const response = await generateWithAI(prompt);
            const problemData = JSON.parse(response);
            return problemData;
        } catch (e) {
            console.warn('Error generando problema con IA, usando fallback:', e);
            return generateFallbackMathProblem();
        }
    }

    function generateFallbackMathProblem() {
        // Fallback simple basado en el rendimiento reciente
        const recentCorrect = state.interactions.math.slice(-5).filter(i => i.isCorrect).length;
        const max = recentCorrect >= 4 ? 20 : (recentCorrect >= 2 ? 10 : 5);

        const a = Math.floor(Math.random() * max);
        const b = Math.floor(Math.random() * max);
        const answer = a + b;
        const distractors = [];
        for (let i = 0; i < 5; i++) {
            let distractor;
            do {
                distractor = answer + Math.floor(Math.random() * 10) - 5;
            } while (distractor === answer || distractor < 0 || distractors.includes(distractor));
            distractors.push(distractor);
        }
        return {
            question: `${a} + ${b}`,
            answer,
            distractors
        };
    }

    async function generateWord(section) {
        const interactions = state.interactions[section];
        const interactionContext = interactions.length > 0
            ? `Historial de últimas interacciones de ${section}: ${JSON.stringify(interactions)}`
            : `Sin historial previo en ${section}.`;

        const activityType = section === 'write' ? 'escritura' : 'pronunciaci��n';

        const prompt = `Eres un tutor de ${activityType} adaptativo para niños de 5-12 años.

${interactionContext}

Basándote en el historial de respuestas (si existe), ajusta automáticamente la dificultad:
- Si el niño acierta consistentemente, incrementa la dificultad de las palabras
- Si falla mucho, usa palabras más simples
- Si no hay historial, empieza con palabras básicas

INSTRUCCIONES CRÍTICAS:
- Responde ÚNICAMENTE con una palabra válida en español
- NO incluyas explicaciones, frases o texto adicional
- La palabra debe tener entre 3 y 12 letras
- Debe ser una palabra común que los niños puedan entender

Ejemplos de respuestas correctas: "casa", "perro", "sol"
Ejemplos de respuestas INCORRECTAS: "intenta contar paso a paso", "tú puedes"

Genera una palabra apropiada para practicar ${activityType}:`;

        try {
            const response = await generateWithAI(prompt);
            if (!response) {
                return generateFallbackWord(section);
            }

            // Limpiar y validar la respuesta
            let word = response.toLowerCase().trim();

            // Remover cualquier texto después de espacios, puntos, comas, etc.
            word = word.split(/[\s.,;:!?]/)[0];

            // Mantener solo letras españolas
            word = word.replace(/[^a-záéíóúñü]/g, '');

            // Validar que sea una palabra válida (3-12 caracteres)
            if (word.length >= 3 && word.length <= 12) {
                return word;
            } else {
                console.warn('Palabra generada por IA inválida:', response, 'usando fallback');
                return generateFallbackWord(section);
            }
        } catch (e) {
            console.warn('Error generando palabra con IA, usando fallback:', e);
            return generateFallbackWord(section);
        }
    }

    function generateFallbackWord(section) {
        // Fallback basado en el rendimiento reciente
        const recentCorrect = state.interactions[section].slice(-5).filter(i => i.isCorrect).length;

        let wordPool;
        if (recentCorrect >= 4) {
            wordPool = ['mariposa', 'guitarra', 'ferrocarril', 'zanahoria', 'helicóptero'];
        } else if (recentCorrect >= 2) {
            wordPool = ['perro', 'gato', 'flor', 'casa', 'libro', 'coche'];
        } else {
            wordPool = ['sol', 'mar', 'pan', 'luz', 'paz'];
        }

        const recentWords = state.interactions[section].slice(-3).map(i => i.challenge);
        const availableWords = wordPool.filter(w => !recentWords.includes(w));

        return availableWords.length > 0
            ? availableWords[Math.floor(Math.random() * availableWords.length)]
            : wordPool[Math.floor(Math.random() * wordPool.length)];
    }

    // ===== Utilidades =====
    function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; } return a; }

    // ===== Inicio =====
    function renderHome() {
        screen.innerHTML = '';
        updateStatusUI();

        const title = document.createElement('div');
        title.className = 'card title';
        title.textContent = 'Elige una actividad para practicar';

        const grid = document.createElement('div');
        grid.className = 'grid3';
        grid.appendChild(bigButton('➕', 'Matemáticas', 'btn-math', renderMath));
        grid.appendChild(bigButton('✏️', 'Escritura', 'btn-write', renderWriting));
        grid.appendChild(bigButton('🎤', 'Habla', 'btn-speak', renderSpeech));
        grid.appendChild(bigButton('🖼️', 'Dibuja', 'btn-draw', renderDraw));

        const gridWrap = document.createElement('div');
        gridWrap.className = 'card section';
        gridWrap.appendChild(grid);

        screen.appendChild(title);
        screen.appendChild(gridWrap);
    }

    function bigButton(emoji, label, cls, onClick) {
        const b = document.createElement('button');
        b.className = `big-btn ${cls}`;
        b.onclick = onClick;
        b.innerHTML = `<div style="font-size:38px">${emoji}</div><div>${label}</div>`;
        return b;
    }

    // ===== Matemáticas =====
    async function renderMath() {
        screen.innerHTML = '';

        const wrap = document.createElement('div');
        wrap.className = 'card section';

        // Mostrar indicador de carga
        wrap.innerHTML = '<div class="prompt">🧠 La IA está generando un problema personalizado...</div>';
        screen.appendChild(wrap);

        try {
            const p = await generateMathProblem();

            wrap.innerHTML = '';
            const prompt = document.createElement('div');
            prompt.className = 'prompt';
            prompt.innerHTML = `¿Cuánto es <b>${p.question}</b>?`;

            const choices = document.createElement('div');
            choices.className = 'choices';

            shuffle([p.answer, ...p.distractors]).slice(0, 6).forEach(v => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                btn.textContent = v;
                btn.onclick = async () => {
                    const ok = Number(v) === Number(p.answer);

                    // Guardar interacci��n
                    saveInteraction('math', p.question, v, ok);

                    const fb = document.createElement('div');
                    fb.className = 'feedback ' + (ok ? 'ok' : 'bad');
                    fb.innerHTML = ok ? `✅ ¡Muy bien! ${v} es correcto 🎉` : `❌ Casi. Intenta otra vez.`;
                    wrap.appendChild(fb);

                    const tip = await aiTip(
                        ok ? `Refuerzo positivo breve por acertar ${p.question}`
                            : `Pista muy breve para ayudar con ${p.question} sin dar la respuesta`
                    );
                    if (tip) wrap.insertAdjacentHTML('beforeend', tip);

                    setTimeout(renderMath, 1500);
                };
                choices.appendChild(btn);
            });

            wrap.appendChild(prompt);
            wrap.appendChild(choices);
        } catch (e) {
            wrap.innerHTML = '<div class="feedback bad">Error generando problema. Int��ntalo de nuevo.</div>';
            setTimeout(renderMath, 2000);
        }
    }

    // ===== Escritura =====
    async function renderWriting() {
        screen.innerHTML = '';

        const box = document.createElement('div');
        box.className = 'card section';
        box.innerHTML = '<div class="prompt">🧠 La IA está seleccionando una palabra personalizada...</div>';
        screen.appendChild(box);

        try {
            const target = await generateWord('write');

            box.innerHTML = `
                <div class="prompt">Escribe la palabra: <b>${target}</b></div>
                <input id='writeInput' class='input' type='text' placeholder='Escribe aquí...'>
                <button class='small' id='checkBtn'>Comprobar ✅</button>
            `;

            document.getElementById('writeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('checkBtn').click();
            });

            document.getElementById('checkBtn').onclick = async () => {
                const v = document.getElementById('writeInput').value.trim().toLowerCase();
                const ok = v === target;

                // Guardar interacción
                saveInteraction('write', target, v, ok);

                const fb = document.createElement('div');
                fb.className = 'feedback ' + (ok ? 'ok' : 'bad');
                fb.innerHTML = ok ? '✅ ¡Perfecto!' : `❌ Se escribe <b>${target}</b>`;
                box.appendChild(fb);

                const tip = await aiTip(
                    ok ? `Refuerzo positivo breve por escribir bien "${target}"`
                        : `Corrección amable: escribió "${v}", lo correcto es "${target}"`
                );
                if (tip) box.insertAdjacentHTML('beforeend', tip);

                setTimeout(renderWriting, 1500);
            };
        } catch (e) {
            box.innerHTML = '<div class="feedback bad">Error generando palabra. Inténtalo de nuevo.</div>';
            setTimeout(renderWriting, 2000);
        }
    }

    // ===== Habla =====
    async function renderSpeech() {
        screen.innerHTML = '';

        const box = document.createElement('div');
        box.className = 'card section';
        box.innerHTML = '<div class="prompt">🧠 La IA está seleccionando una palabra personalizada...</div>';
        screen.appendChild(box);

        try {
            const target = await generateWord('speak');

            const support = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);

            box.innerHTML = `
                <div class="prompt">Di la palabra: <b>${target}</b></div>
                <div class="input-container">
                    <div class="speech-input">
                        <div id="speechDisplay" class="speech-display">Presiona el botón y di la palabra</div>
                        <div class="speech-hint">
                            <span class="pill">Pista: ${target.split('').join('-')}</span>
                        </div>
                    </div>
                </div>
                <button class='small' id='speakBtn' ${!support ? 'disabled' : ''}>🎤 Empezar a hablar</button>
                <div id='speechResult' class='feedback'></div>
            `;

            if (!support) {
                document.getElementById('speechResult').innerHTML = '<div class="feedback bad">⚠️ Micrófono no disponible en este navegador.</div>';
                return;
            }

            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

            async function ensureMicPermission() {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                s.getTracks().forEach(t => t.stop());
            }

            document.getElementById('speakBtn').onclick = async () => {
                const result = document.getElementById('speechResult');
                const display = document.getElementById('speechDisplay');
                const btn = document.getElementById('speakBtn');

                try {
                    await ensureMicPermission();
                } catch {
                    result.innerHTML = '<div class="feedback bad">⚠️ Permiso de micrófono denegado.</div>';
                    return;
                }

                // Crear nueva instancia del reconocedor para evitar concatenación
                const recog = new SR();
                recog.lang = 'es-ES';
                recog.interimResults = false;
                recog.maxAlternatives = 1;

                // Actualizar UI durante grabación
                btn.disabled = true;
                btn.textContent = '🔴 Escuchando...';
                display.textContent = '👂 Te estoy escuchando, di la palabra ahora...';
                result.innerHTML = '';

                recog.onresult = async (e) => {
                    const said = e.results[0][0].transcript.trim().toLowerCase();
                    const ok = said === target;

                    // Restaurar botón
                    btn.disabled = false;
                    btn.textContent = '🎤 Empezar a hablar';
                    display.textContent = `Dijiste: "${said}"`;

                    // Guardar interacción
                    saveInteraction('speak', target, said, ok);

                    result.className = 'feedback ' + (ok ? 'ok' : 'bad');
                    result.innerHTML = ok
                        ? `✅ ¡Muy bien! Dijiste <b>${target}</b> correctamente 🎉`
                        : `❌ Dijiste "${said}". Intenta decir <b>${target}</b>`;

                    const tip = await aiTip(
                        ok ? `Refuerzo positivo breve por pronunciar bien "${target}"`
                            : `Anima brevemente al niño a repetir "${target}"`
                    );
                    if (tip) box.insertAdjacentHTML('beforeend', tip);

                    setTimeout(renderSpeech, 2000);
                };

                recog.onerror = (e) => {
                    btn.disabled = false;
                    btn.textContent = '🎤 Empezar a hablar';
                    display.textContent = 'Error al escuchar. Intenta de nuevo.';
                    result.innerHTML = '<div class="feedback bad">⚠�� No pude escucharte. Verifica tu micrófono e intenta otra vez.</div>';
                };

                recog.onend = () => {
                    btn.disabled = false;
                    btn.textContent = '🎤 Empezar a hablar';
                    if (display.textContent === '👂 Te estoy escuchando, di la palabra ahora...') {
                        display.textContent = 'No se detectó audio. Intenta otra vez.';
                    }
                };

                try {
                    recog.start();
                } catch (e) {
                    btn.disabled = false;
                    btn.textContent = '🎤 Empezar a hablar';
                    display.textContent = 'Error al iniciar grabación';
                    result.innerHTML = '<div class="feedback bad">⚠️ Error al acceder al micrófono.</div>';
                }
            };
        } catch (e) {
            box.innerHTML = '<div class="feedback bad">Error generando palabra. Inténtalo de nuevo.</div>';
            setTimeout(renderSpeech, 2000);
        }
    }

    // ===== Dibuja con IA =====
    async function renderDraw() {
        screen.innerHTML = '';

        const box = document.createElement('div');
        box.className = 'card section';
        box.innerHTML = `
            <div class="prompt">Describe lo que quieres ver:</div>
            <input id='imgPrompt' class='input' type='text' placeholder='Un perro astronauta...'>
            <div class="prompt">Elige un estilo:</div>
            <select id='imgStyle' class='input'>
                <option value='dibujo infantil'>Dibujo infantil</option>
                <option value='acuarela'>Acuarela</option>
                <option value='cómic'>Cómic</option>
                <option value='realista suave'>Realista suave</option>
            </select>
            <button class='small' id='imgBtn'>Generar 🎨</button>
            <div id='imgResult'></div>
        `;
        screen.appendChild(box);
        const BAD = ['violencia', 'sangre', 'arma', 'matar', 'desnudo'];

        document.getElementById('imgBtn').onclick = async () => {
            const prompt = document.getElementById('imgPrompt').value.trim();
            const style = document.getElementById('imgStyle').value;
            const result = document.getElementById('imgResult');
            if (!prompt) return;
            if (BAD.some(b => prompt.toLowerCase().includes(b))) {
                result.innerHTML = '<div class="feedback bad">Palabras no permitidas.</div>';
                return;
            }
            result.innerHTML = '⌛ Generando imagen...';
            const blob = await generateImage(prompt, style);
            if (!blob) {
                result.innerHTML = '<div class="feedback bad">Error generando imagen.</div>';
                return;
            }
            const url = URL.createObjectURL(blob);
            result.innerHTML = `<img src="${url}" alt="Imagen generada" style="max-width:100%;border-radius:16px;">`;
        };
    }

    // ==== Start ====
    renderHome();
</script>
</body>

</html>
